%
% task2.tex
%
% Use kernel semaphores to implement userland semaphores.
%

\section{Userland semaphores}
Using the already implemented kernel semaphores, we will extend the
implementation to support userland semaphores.

\subsection{Preliminary}
We started out by adding the system call switch identifiers to
\file{proc/syscall.h}, such that we can recognize these. The identifier values
were specified by the assignment text.
\begin{figure}[H]
    \lstinputlisting[firstnumber=56,firstline=56,lastline=58]
    {../../../src/proc/syscall.h}
    \label{code:syscall-identifiers}
    \caption{Code excerpt showing the added system call identifiers.}
\end{figure}
Having the identifiers in place we went on to add each of these to the cases
of the system call handle switch.
\begin{figure}[H]
    \lstinputlisting[firstnumber=167,firstline=167,lastline=175]
    {../../../src/proc/syscall.c}
    \label{code:syscall-switch}
    \caption{Code excerpt showing the added system call switch cases.}
\end{figure}
Note that at this time we put in place the corresponding functions, but their
bodies were simply triggering a kernel panic. These will be revised later.

Now that we are able to receive such system calls, we went on to implement the
userland library functions that will delegate the work on to these system
call handlers. So we declared the \code{usr\_sem\_t} type in
\file{tests/lib.h}, which serves to describe a userland semaphore.
\begin{figure}[H]
    \lstinputlisting[firstnumber=47,firstline=47,lastline=49]
    {../../../src/tests/lib.h}
    \label{code:usr_sem_t}
    \caption{Code excerpt showing the \code{usr\_sem\_t} type declaration.}
\end{figure}
Further, we added the prototype semaphore functions in \file{tests/lib.h} for
the userland library.
\begin{figure}[H]
    \lstinputlisting[firstnumber=74,firstline=74,lastline=77]
    {../../../src/tests/lib.h}
    \label{code:userland-library-prototypes}
    \caption{Code excerpt showing the userland library prototype functions.}
\end{figure}
Lastly, for bridging the gap from the userland library in \file{tests/lib.h}
to the actual system call handlers in \file{proc/syscall.h}, we implemented
the userland library functions in \file{tests/lib.c}.
\begin{figure}[H]
    \lstinputlisting[firstnumber=193,firstline=193,lastline=213]
    {../../../src/tests/lib.c}
    \label{code:userland-library-implementation}
    \caption{Code excerpt showing the userland library implementation.}
\end{figure}
